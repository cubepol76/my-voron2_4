
[include bed_mesh.cfg]
[include calibrate.cfg]
[include display_menu.cfg]
[include display.cfg]
[include fan.cfg]
[include filament.cfg]
[include heater.cfg]
[include homing_qgl.cfg]
[include macro_basic.cfg]
[include macro_printing.cfg]
[include neopixel_colors.cfg]
[include neopixel_status.cfg]
[include position.cfg]
[include printplate.cfg]
[include stepper.cfg]
[include tmc.cfg]
#[include tmc_autotune.cfg]

[include my_mainsail.cfg]

[include K-ShakeTune/*.cfg]


####################################################################################################
#  MCU CAN Settings
####################################################################################################
[mcu]
canbus_uuid: bf150d0cd8b7
[mcu EBBCan]
canbus_uuid: 79a981598962

####################################################################################################
#  Printer Limits
####################################################################################################
[printer]
kinematics:             corexy
max_velocity:           400
max_accel:              5500
max_accel_to_decel:     3000
max_z_velocity:         30
max_z_accel:            350
square_corner_velocity: 5.0


####################################################################################################
#  Activate some modules
####################################################################################################
[exclude_object]


####################################################################################################
#  File location of stored varibales
####################################################################################################
[save_variables]
filename: /home/pi/printer_data/config/.variables.stb


####################################################################################################
#  Idle Timeout
####################################################################################################
[idle_timeout]
timeout: 1800
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      {action_respond_info("POWER: Execute Idle Timeout")}
      PERIPH_RESET STEPPER_OFF=1
    {% endif %}
  {% endif %}


####################################################################################################
#  Macro that run at klipper start
####################################################################################################
[delayed_gcode _INIT]
initial_duration: 1
gcode:
  _GLOBAL_VARIABLE
  _EXECUTE_AT_INIT


###################################################################################################
#  Execute at start
###################################################################################################
[gcode_macro _EXECUTE_AT_INIT]
description: Helper: Everything that should run at klipper start
gcode:
  SDCARD_RESET_FILE
  PERIPH_RESET
  _PLATE_SET_AT_STARTUP
  {action_respond_info("********** Klipper INIT done **********")}


####################################################################################################
#  Turn off all periphery
####################################################################################################
[gcode_macro PERIPH_RESET]
gcode:
  ### Input parameter ##############################################################################
  {% set p_stepper_off = params.STEPPER_OFF|default(0)|int %}
  ##################################################################################################
  {% if p_stepper_off !=0 %}
    M84                               # turn steppers off
  {% endif %}

  TURN_OFF_HEATERS                    # turn bed / hotend off
  M107                                # turn player cooling fan off
  _SET_EXHAUST S=0                    # turn exhaust fan off
  _SET_VENT S=0                       # bed fan off


####################################################################################################
#  Shutdown the printer
####################################################################################################
[gcode_macro PRINTER_OFF]
description: Park head and Power down the Raspi
gcode:
  M117 PI Off in 5 sec
  G4 P5000
  M400
  PERIPH_RESET STEPPER_OFF=1
  {action_respond_info('action:poweroff')}
  {action_call_remote_method("shutdown_machine")}



####################################################################################################
#  NeoPixel LED
####################################################################################################
[neopixel chamber]
pin:            PB0
chain_count:    82
color_order:    GRB
initial_RED:    0.4
initial_GREEN:  0.4
initial_BLUE:   0.4

[neopixel hotend]
pin:            EBBCan:PD3
chain_count:    3
color_order:    GRB

[neopixel display]
pin:            PE13
chain_count:    3
color_order:    RGB
initial_RED:    0.2
initial_GREEN:  0.1
initial_BLUE:   0.1

####################################################################################################
#  Activates G2 and G3
####################################################################################################
[gcode_arcs]
resolution: 0.2



####################################################################################################
#  Resonace compesation
####################################################################################################
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: -z,x,-y


[resonance_tester]
accel_chip: adxl345
probe_points: 175, 175, 20

[input_shaper]
shaper_freq_x: 54.0
shaper_type_x: mzv
shaper_freq_y: 37.2
shaper_type_y: zv



####################################################################################################
#  User Variable
####################################################################################################
[gcode_macro _GLOBAL_VARIABLE]
description: Helper: Contains User defined printer variables
variable_speed: {}
variable_pos: {}
variable_move: {}
variable_param: {}
variable_unload_sd: False
gcode:
  #  Speed Variable
  ###################################################################################################
  {% set user_speed_homing = [80, 80, 20] %}
  {% set user_speed_travel = [200, 200, 25] %}
  {% set user_speed_zhop = 15 %}
  {% set user_speed_pos = 120 %}
  {% set user_speed_unload = 10 %}
  {% set user_speed_wipe = 50 %}
  {% set user_speed_prime = 30 %}
  {% set user_speed_retract = 30 %}
  {% set user_speed_unretract = 30 %}

  # prepare dictonaries
  {% set speed_dic = {'homing':        {'x': (user_speed_homing[0] * 60),
                                        'y': (user_speed_homing[1] * 60),
                                        'z': (user_speed_homing[2] * 60)},
                      'travel':        {'x': (user_speed_travel[0] * 60),
                                        'y': (user_speed_travel[1] * 60),
                                        'z': (user_speed_travel[2] * 60)},
                      'zhop':                (user_speed_zhop * 60),
                      'pos':                 (user_speed_pos * 60),
                      'unload':              (user_speed_unload * 60),
                      'wipe':                (user_speed_wipe * 60),
                      'prime':               (user_speed_prime * 60),
                      'retract':             (user_speed_retract * 60),
                      'unretract':           (user_speed_unretract * 60),}
  %}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARIABLE VARIABLE=speed VALUE="{speed_dic}"


  #  Position Variable
  ###################################################################################################
  {% set user_pos_homing =  [175, 156] %}
  {% set user_pos_home =    [175, 175, 20] %}
  {% set user_pos_tray =    [45, 351, 10] %}
  {% set user_pos_wipe =    [75, 348, 1] %}
  {% set user_pos_prime =   [3, 175, 0.5] %}
  {% set user_pos_park =    [175, 100, 120] %}

  # prepare dictonaries
  {% set pos_dic = {'homing': {'x': user_pos_homing[0],
                               'y': user_pos_homing[1]},
                    'home':   {'x': user_pos_home[0],
                               'y': user_pos_home[1],
                               'z': user_pos_home[2]},
                    'tray':   {'x': user_pos_tray[0],
                               'y': user_pos_tray[1],
                               'z': user_pos_tray[2]},
                    'wipe':   {'x': user_pos_wipe[0],
                               'y': user_pos_wipe[1],
                               'z': user_pos_wipe[2]},
                    'prime':  {'x': user_pos_prime[0],
                               'y': user_pos_prime[1],
                               'z': user_pos_prime[2]},
                    'park':   {'x': user_pos_park[0],
                               'y': user_pos_park[1],
                               'z': user_pos_park[2]}}
  %}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARIABLE VARIABLE=pos VALUE="{pos_dic}"


  #  Move Variable
  ###################################################################################################
  {% set user_move_unload = 50 %}
  {% set user_move_retract_pause = 2 %}
  {% set user_move_retract_cancel = 5 %}
  {% set user_move_unretract_resume = 3 %}
  {% set user_move_zhop = 10 %}
  {% set user_move_wipe = [50, 4] %}
  {% set user_move_prime = [2, 100] %}


  # prepare dictonaries
  {% set move_dic = {'unload':    user_move_unload,
                     'zhop':      user_move_zhop,
                     'retract':   {'pause': user_move_retract_pause,
                                   'cancel': user_move_retract_cancel},
                     'unretract': {'resume': user_move_unretract_resume},
                     'wipe':      {'x': user_move_wipe[0],
                                   'y': user_move_wipe[1]},
                     'prime':     {'x': user_move_prime[0],
                                   'y': user_move_prime[1]}}
  %}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARIABLE VARIABLE=move VALUE="{move_dic}"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.489
#*# pid_ki = 1.326
#*# pid_kd = 79.138
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 48.178
#*# pid_ki = 1.746
#*# pid_kd = 332.425
#*#
#*# [beacon model default]
#*# model_coef = 1.4975079029703007,
#*# 	1.8170331114409335,
#*# 	0.7563138937230361,
#*# 	0.38943491415145487,
#*# 	0.3187476215195218,
#*# 	0.2109757987059638,
#*# 	-0.15186977436569093,
#*# 	-0.16263351381439348,
#*# 	0.179820987658869,
#*# 	0.14750210736975763
#*# model_domain = 3.222202464626171e-07,3.344036690847519e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 26.229511
#*# model_offset = 0.00000
#*#
#*# [bed_mesh pei-glatt--Bed-Temp-0]
#*# version = 1
#*# points =
#*# 	0.022521, 0.030097, 0.048514, 0.067701, 0.065115, 0.050743, 0.049580
#*# 	0.000148, 0.007962, 0.029204, 0.047799, 0.047335, 0.036609, 0.006379
#*# 	-0.021563, -0.015346, 0.009162, 0.030636, 0.035152, 0.026630, 0.003498
#*# 	-0.058834, -0.046076, -0.023884, 0.002384, 0.007296, 0.006974, -0.016442
#*# 	-0.024361, -0.020068, 0.007055, 0.028091, 0.029497, 0.030673, 0.004310
#*# 	0.004992, 0.003162, 0.022990, 0.040804, 0.042032, 0.039308, 0.015672
#*# 	0.035105, 0.015404, 0.034473, 0.048161, 0.045020, 0.043391, 0.016619
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [bed_mesh pei-glatt--Bed-Temp-45]
#*# version = 1
#*# points =
#*# 	0.012803, 0.019598, 0.039443, 0.060439, 0.060043, 0.046942, 0.032271
#*# 	-0.019978, -0.010719, 0.011192, 0.031963, 0.037182, 0.026518, -0.000470
#*# 	-0.041381, -0.030339, -0.004603, 0.019166, 0.026911, 0.019071, -0.007029
#*# 	-0.072949, -0.064543, -0.035540, -0.008560, -0.000830, -0.001834, -0.024852
#*# 	-0.040794, -0.033756, -0.004628, 0.016855, 0.019801, 0.019510, -0.008390
#*# 	-0.014069, -0.012452, 0.009235, 0.027968, 0.030631, 0.026557, -0.000317
#*# 	0.024936, 0.001655, 0.024104, 0.039084, 0.035761, 0.031685, 0.004977
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [bed_mesh pei-glatt--Bed-Temp-60]
#*# version = 1
#*# points =
#*# 	0.006818, 0.018143, 0.040039, 0.061402, 0.057275, 0.042222, 0.048276
#*# 	-0.009614, 0.003560, 0.027443, 0.048407, 0.045896, 0.033477, -0.001576
#*# 	-0.030280, -0.018973, 0.010013, 0.032337, 0.035585, 0.022862, -0.003898
#*# 	-0.063956, -0.047948, -0.021842, 0.006055, 0.009053, 0.005556, -0.022439
#*# 	-0.030734, -0.020312, 0.009231, 0.031612, 0.031581, 0.026507, -0.004092
#*# 	-0.002607, 0.000857, 0.023033, 0.041583, 0.041209, 0.033954, 0.005100
#*# 	0.033383, 0.009004, 0.032964, 0.048207, 0.041684, 0.034645, 0.003163
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [bed_mesh pei-glatt--Bed-Temp-100]
#*# version = 1
#*# points =
#*# 	-0.025127, 0.001486, 0.031669, 0.056334, 0.050819, 0.026764, 0.045156
#*# 	-0.034399, -0.006209, 0.029329, 0.048179, 0.039754, 0.019096, -0.027037
#*# 	-0.056154, -0.029052, 0.009530, 0.033050, 0.033463, 0.015150, -0.027435
#*# 	-0.086731, -0.060056, -0.025344, 0.006837, 0.006416, -0.004385, -0.043928
#*# 	-0.056566, -0.031213, 0.010183, 0.036349, 0.032996, 0.020073, -0.023587
#*# 	-0.034177, -0.014243, 0.019270, 0.043052, 0.039818, 0.025061, -0.015213
#*# 	0.029783, -0.003647, 0.030469, 0.047977, 0.037976, 0.023931, -0.020211
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [bed_mesh pei-glatt--Bed-Temp-110]
#*# version = 1
#*# points =
#*# 	-0.033781, -0.004627, 0.028488, 0.053809, 0.045785, 0.017678, 0.041012
#*# 	-0.039065, -0.008057, 0.022824, 0.047446, 0.041487, 0.015759, -0.038172
#*# 	-0.058112, -0.028219, 0.012059, 0.039573, 0.028116, 0.004988, -0.040710
#*# 	-0.095166, -0.061374, -0.021771, 0.009097, 0.004678, -0.010572, -0.058117
#*# 	-0.060611, -0.033042, 0.012963, 0.039408, 0.033377, 0.018249, -0.036447
#*# 	-0.036362, -0.016440, 0.019295, 0.042273, 0.037040, 0.019569, -0.027555
#*# 	0.028949, -0.006303, 0.030010, 0.047605, 0.034150, 0.015719, -0.035695
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [beacon model pei-glatt]
#*# model_coef = 1.4700346007311142,
#*# 	  1.7850605672110191,
#*# 	  0.7512131828383792,
#*# 	  0.38050649429892525,
#*# 	  0.34550119237963595,
#*# 	  0.2717660631821611,
#*# 	  -0.1615926935913578,
#*# 	  -0.20476596337777833,
#*# 	  0.1954518756762424,
#*# 	  0.16963229669050328
#*# model_domain = 3.2041882226942913e-07,3.3451008048496376e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 44.841716
#*# model_offset = 0.29000
#*#
#*# [beacon model carbon-glatt]
#*# model_coef = 1.4700346007311142,
#*# 	1.7850605672110191,
#*# 	0.7512131828383792,
#*# 	0.38050649429892525,
#*# 	0.34550119237963595,
#*# 	0.2717660631821611,
#*# 	-0.1615926935913578,
#*# 	-0.20476596337777833,
#*# 	0.1954518756762424,
#*# 	0.16963229669050328
#*# model_domain = 3.2041882226942913e-07,3.3451008048496376e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 44.841716
#*# model_offset = -0.17500
#*#
#*# [bed_mesh carbon-glatt--Bed-Temp-100]
#*# version = 1
#*# points =
#*# 	-0.018905, 0.010464, 0.044817, 0.074164, 0.067381, 0.042053, 0.062719
#*# 	-0.031432, 0.004967, 0.034253, 0.056606, 0.056492, 0.023623, -0.029781
#*# 	-0.053544, -0.023192, 0.018388, 0.042946, 0.045940, 0.019808, -0.034470
#*# 	-0.097357, -0.062399, -0.009929, 0.012763, 0.014147, -0.008756, -0.061862
#*# 	-0.067265, -0.028681, 0.009787, 0.037023, 0.034133, 0.010439, -0.044769
#*# 	-0.047467, -0.023874, 0.014550, 0.037344, 0.031804, 0.009067, -0.044621
#*# 	0.043555, 0.009772, 0.046436, 0.062509, 0.048337, 0.026755, -0.019871
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
